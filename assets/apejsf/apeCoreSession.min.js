APE.Core=new Class({Extends:APE.Core,initialize:function(a){if(this.getInstance(a.identifier).instance){a.restore=true}this.parent(a);if(a.restore){this.init()}this.addEvent("uniPipeCreate",this.saveSessionPipe);this.addEvent("uniPipeDelete",this.saveSessionPipe)},saveSessionPipe:function(){var a=[];this.pipes.each(function(b){if(b.type=="uni"){a.push({casttype:b.type,pubid:b.pipe.pubid,properties:b.properties})}});this.setSession({uniPipe:JSON.stringify(a)})},restoreUniPipe:function(c){var b=JSON.parse(decodeURIComponent(c.data.sessions.uniPipe));if(b){for(var a=0;a<b.length;a++){this.newPipe("uni",{pipe:b[a]})}}this.fireEvent("restoreEnd");this.restoring=false},init:function(){this.initCookie();this.createCookie();this.saveCookie()},restoreCallback:function(a){if(a.raw!="ERR"&&this.status==0){this.fireEvent("init");this.fireEvent("ready");this.status=1}else{if(this.status==0){this.stopPoller()}}},connect:function(b,a){var c=this.initCookie();if(!c){this.addEvent("init",this.init);this.parent(b,a)}else{if(!a){a={}}if(!a.request){a.request="stack"}a.requestCallback=this.restoreCallback.bind(this);this.restoring=true;this.fireEvent("restoreStart");this.startPoller();this.getSession("uniPipe",this.restoreUniPipe.bind(this),a)}},getInstance:function(a){var c=Cookie.read("APE_Cookie",{domain:document.domain});a=a||this.options.identifier;if(!c){return false}c=JSON.parse(c);if(!c||!c.instance){return false}for(var b=0;b<c.instance.length;b++){if(c.instance[b]&&c.instance[b].identifier==a){return{instance:c.instance[b],cookie:c}}}return{cookie:c}},removeInstance:function(a){if(!this.cookie){return}for(var b=0;b<this.cookie.instance.length;b++){if(this.cookie.instance[b].identifier==a){this.cookie.instance.splice(b,1);return}}},initCookie:function(){var a=this.getInstance();if(a&&a.instance){this.sessid=a.instance.sessid;this.pubid=a.instance.pubid;a.cookie.frequency=a.cookie.frequency.toInt()+1;this.cookie=a.cookie;return true}else{if(a.cookie){this.createInstance(a.cookie);a.cookie.frequency=a.cookie.frequency.toInt()+1;this.cookie=a.cookie;return false}else{this.cookie=null;return false}}},createInstance:function(a){a.instance.push({identifier:this.options.identifier,pubid:this.getPubid(),sessid:this.getSessid()})},createCookie:function(){if(!this.cookie){var a={frequency:1,instance:[]};this.createInstance(a);this.cookie=a}},saveCookie:function(){Cookie.write("APE_Cookie",JSON.stringify(this.cookie),{domain:document.domain})},clearSession:function(){this.parent();this.removeInstance(this.options.identifier);this.saveCookie()},removeCookie:function(){Cookie.dispose("APE_Cookie",{domain:this.options.domain})}});